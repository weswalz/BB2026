# Claude Code Instructions for BiYu Boxing Website

## CRITICAL: Read Before Every Task

**ALWAYS read `/var/www/biyuboxing/ARCHITECTURE.md` before starting any work on this codebase.**

The ARCHITECTURE.md document contains:
- Complete system architecture and data flow
- Database schema with all tables and relationships
- Security concerns (admin panel has NO authentication)
- All routes, components, and API endpoints
- Performance optimization guidelines
- Deployment procedures
- Known issues and TODOs

## Quick Reference

### Project Structure
- **Frontend:** Astro 5.x (SSR mode), TypeScript/JavaScript
- **Database:** SQLite with better-sqlite3
- **Server:** Node.js v22.11.0, PM2 on Ubuntu 24.04
- **Reverse Proxy:** Nginx with gzip, caching, security headers
- **Deployment:** Port 4321 (production), 3002 (staging)

### Key Directories
- `src/pages/` - Public routes and admin panel
- `src/components/` - Reusable UI components
- `src/lib/` - Database functions and business logic
- `database/` - SQLite database file
- `public/images/` - Static media assets

### Database Tables
- `fighters` - Fighter roster data
- `events` - Upcoming/past boxing events
- `news` - News articles and press releases
- `pages` - CMS content for editable pages (8 pages populated)
- `media` - File upload tracking (created 2025-10-03)
- `globals` - Site-wide settings (schema exists, needs population)

### Critical Files
- `src/lib/database.js` - Core database connection and queries
- `src/lib/fighters.js` - Fighter CRUD operations
- `src/lib/events.js` - Event CRUD operations
- `src/lib/news.js` - News CRUD operations
- `src/lib/pages.js` - CMS page content management
- `astro.config.mjs` - Build and server configuration

### Build & Deploy Commands
```bash
npm run build          # Build for production
pm2 restart biyuboxing # Restart production app
pm2 restart staging-biyuboxing # Restart staging
```

### Database Queries
```bash
# Access production database
sqlite3 /var/www/biyuboxing/database/biyuboxing.db

# Check schema
.schema

# View data
SELECT * FROM fighters;
SELECT * FROM events;
SELECT * FROM news;
SELECT * FROM pages;
```

## Recent Fixes (2025-10-03)

### ✅ Completed
1. **Media table created** - Added `media` table to database with proper schema
2. **Pages error handling fixed** - Added JSON parsing error handling in `src/lib/pages.js`
3. **VIP signup form fixed** - Changed from JSON to FormData submission in `src/components/sections/VipSignup.astro`
4. **Admin news panel fixed** - Corrected `article._id` to `article.id` in `src/pages/admin/news.astro`
5. **Pages table populated** - 8 CMS pages are now seeded with content

## Current Known Issues

### Critical (Security)
1. **No authentication on admin panel** - Admin routes at `/admin/*` are publicly accessible
2. No CSRF protection on forms
3. No input validation on admin forms

### High Priority (Functionality)
1. **Events table missing columns:** `featured`, `createdAt`, `updatedAt`
2. **News table missing columns:** `category`, `seoTitle`, `seoDescription`, `tags`
3. **Globals table schema exists but not populated** - Site-wide settings not implemented
4. **DELETE functionality missing** in some admin panels
5. **Media library DELETE** not fully implemented

### Medium Priority
1. Admin forms lack validation
2. No success/error message feedback on admin operations
3. Missing database indexes for query optimization

## Workflow Guidelines

### Before Making Changes
1. ✅ **Read ARCHITECTURE.md** to understand system design
2. Check current TODO list in this session
3. Review related files in `src/lib/` for business logic
4. Test on staging environment first if available

### When Adding Features
1. Update database schema if needed (add migrations)
2. Implement business logic in `src/lib/*.js`
3. Create/update admin panel UI in `src/pages/admin/`
4. Update public pages in `src/pages/` to consume new data
5. Test CRUD operations thoroughly
6. Rebuild and restart: `npm run build && pm2 restart biyuboxing`

### When Modifying Database
1. Create SQL migration file in `database/migrations/` (if migration system exists)
2. Apply schema changes to production database carefully
3. Backup database first: `sqlite3 db.db ".backup backup.db"`
4. Update type definitions if using TypeScript
5. Update CRUD functions in `src/lib/` accordingly

### When Debugging
1. Check PM2 logs: `pm2 logs biyuboxing --lines 100`
2. Check database integrity: `sqlite3 db.db "PRAGMA integrity_check;"`
3. Test API routes directly: `curl http://localhost:4321/api/fighters`
4. Review Nginx logs: `sudo tail -f /var/log/nginx/error.log`

## Style Guidelines

### Code Style
- Use prepared statements for all SQL queries (security)
- Always handle errors with try-catch
- Log operations with emoji prefixes (✅ success, ❌ error, ⚠️ warning)
- Return consistent data structures from lib functions

### Component Patterns
- Astro components for UI (`.astro` files)
- Server-side data fetching in frontmatter (`---` blocks)
- Minimal client-side JavaScript (Astro's zero-JS philosophy)
- Use `getField()` pattern for CMS-editable content

### Database Patterns
- Use UUIDs for primary keys (via `randomUUID()`)
- Generate slugs from titles for SEO-friendly URLs
- Store timestamps as ISO strings
- JSON-encode complex data (e.g., `fights` array in events)

## Common Tasks

### Add New Content Type
1. Create table in database
2. Add CRUD functions in `src/lib/[type].js`
3. Create admin list page: `src/pages/admin/[type].astro`
4. Create admin create page: `src/pages/admin/[type]/new.astro`
5. Create admin edit page: `src/pages/admin/[type]/edit/[id].astro`
6. Create public display pages in `src/pages/[type]/`
7. Add navigation links in admin panel

### Update CMS Page Content
1. Access page data via `getPage('page-id')`
2. Read fields: `getField('fieldName', 'defaultValue')`
3. Admin edits in: `src/pages/admin/pages/[page-name].astro`
4. Saves to `pages` table as JSON in `content` column

### Deploy Updates
```bash
cd /var/www/biyuboxing
npm run build
pm2 restart biyuboxing
# Verify: curl http://localhost:4321/api/health
```

## Emergency Contacts

- Database location: `/var/www/biyuboxing/database/biyuboxing.db`
- Backup location: `/var/www/biyuboxing/database/backups/`
- Production URL: https://biyuboxing.com
- Staging URL: http://biyuboxing.com:3002 (if configured)

## Resources

- Astro Docs: https://docs.astro.build
- better-sqlite3 Docs: https://github.com/WiseLibs/better-sqlite3
- SQLite Docs: https://www.sqlite.org/docs.html
- PM2 Docs: https://pm2.keymetrics.io/docs/

---

**Last Updated:** 2025-10-03 (Session fixes applied)
**Maintained By:** Development Team
**Document Version:** 1.1
